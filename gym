#!/bin/bash

# å¥èº«æˆ¿å›æœ¬è®¡åˆ’ - ç»Ÿä¸€å¯åŠ¨è„šæœ¬
# ç”¨æ³•: ./gym [admin|public]

case "$1" in
  admin)
    echo "ğŸš€ å¯åŠ¨ç®¡ç†åå°..."
    ./start-admin.sh
    ;;
  public)
    echo "ğŸš€ å¯åŠ¨å…¬å¼€å±•ç¤ºé¡µ..."
    ./start-public.sh
    ;;
  *)
    echo "ğŸš€ å¯åŠ¨å¥èº«æˆ¿å›æœ¬è®¡åˆ’ - å®Œæ•´æœåŠ¡..."
    echo ""

    # æ€æ‰å·²æœ‰çš„è¿›ç¨‹
    echo "ğŸ“¦ æ¸…ç†æ—§è¿›ç¨‹..."
    lsof -ti:5002 | xargs kill -9 2>/dev/null
    lsof -ti:5173 | xargs kill -9 2>/dev/null
    lsof -ti:5174 | xargs kill -9 2>/dev/null
    sleep 1

    # å¯åŠ¨åç«¯
    echo "ğŸ”§ å¯åŠ¨åç«¯ API (ç«¯å£ 5002)..."
    cd backend
    python app.py &
    BACKEND_PID=$!
    cd ..

    # ç­‰å¾…åç«¯å¯åŠ¨
    sleep 2

    # å¯åŠ¨ç®¡ç†å‰ç«¯
    echo "âš›ï¸  å¯åŠ¨ç®¡ç†å‰ç«¯ (ç«¯å£ 5173)..."
    npm run dev:admin &
    ADMIN_PID=$!

    # ç­‰å¾…ä¸€ä¸‹
    sleep 1

    # å¯åŠ¨å…¬å¼€å‰ç«¯
    echo "ğŸŒ å¯åŠ¨å…¬å¼€å‰ç«¯ (ç«¯å£ 5174)..."
    npm run dev:public &
    PUBLIC_PID=$!

    echo ""
    echo "âœ… å¯åŠ¨å®Œæˆ!"
    echo ""
    echo "ğŸ“ è®¿é—®åœ°å€:"
    echo "   ç®¡ç†åå°: http://localhost:5173/"
    echo "   å…¬å¼€å±•ç¤ºé¡µ: http://localhost:5174/public.html"
    echo "   åç«¯ API: http://localhost:5002/"
    echo ""
    echo "ğŸ’¡ æŒ‰ Ctrl+C åœæ­¢æ‰€æœ‰æœåŠ¡"
    echo ""

    # ç­‰å¾…ç”¨æˆ·ä¸­æ–­
    trap "echo ''; echo 'ğŸ›‘ åœæ­¢æ‰€æœ‰æœåŠ¡...'; kill $BACKEND_PID $ADMIN_PID $PUBLIC_PID 2>/dev/null; exit" INT TERM

    # ä¿æŒè„šæœ¬è¿è¡Œ
    wait
    ;;
esac
